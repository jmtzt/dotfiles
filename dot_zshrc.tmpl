{{- /* ~/.zshrc (chezmoi template) */ -}}

# Oh My Zsh core
export ZSH="$HOME/.oh-my-zsh"
export ZSH_CUSTOM="$HOME/.config/zsh/custom"
ZSH_THEME="mitsuhiko"

# Python venv
python_venv() {
  MYVENV=./.venv
  [[ -d $MYVENV ]] && source $MYVENV/bin/activate > /dev/null 2>&1
  [[ ! -d $MYVENV ]] && deactivate > /dev/null 2>&1
}
autoload -U add-zsh-hook
add-zsh-hook chpwd python_venv

# Plugins (must be installed/cloned under $ZSH_CUSTOM/plugins or oh-my-zsh/plugins)
plugins=(
  git git-prompt
  zsh-fzf-history-search
  zsh-autosuggestions
  fast-syntax-highlighting
  zsh-syntax-highlighting
  direnv
)

# Load oh-my-zsh
source $ZSH/oh-my-zsh.sh

# --- Aliases ---
alias kc="kubectl"
alias oc="opencode"
alias ns="kubens | fzf | xargs -I {} kubens {}"
alias ctx="kubectx | fzf | xargs -I {} kubectx {}"
alias ctl="kubectl get pods | fzf | awk '{print \$1}' | xargs -I {} kubectl exec -it {} -- /bin/sh"
alias cops="gh copilot suggest"
alias cope="gh copilot explain"
alias ca="conda activate "
alias cde="conda deactivate"
alias n="nnn"
alias vim="NVIM_APPNAME=nvim-mini nvim"
alias vi="NVIM_APPNAME=nvim-mini nvim"
alias nvim="NVIM_APPNAME=nvim-mini nvim"
alias t="tree --gitignore"
alias leet="vim leetcode.nvim"
alias av="source .venv/bin/activate"
alias todo="vim ~/work/todo.md"
alias lzd='lazydocker'
alias mvim="NVIM_APPNAME=nvim-mini nvim"

# fd alias for Ubuntu (package name: fdfind)
command -v fdfind >/dev/null 2>&1 && alias fd="fdfind"

# --- Completion cache ---
autoload -Uz compinit
if [ ! -f "$HOME/.zcompdump" ] || find "$HOME/.zcompdump" -mtime +1 >/dev/null 2>&1; then
  compinit
else
  compinit -C
fi

# --- Tools integration ---
eval "$(thefuck --alias 2>/dev/null || true)"
eval "$(direnv hook zsh)"
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init --cmd cd zsh)"
fi

# zsh plugin extras (autosuggestions, syntax highlighting)
[ -f "$ZSH_CUSTOM/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh" ] && source "$ZSH_CUSTOM/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh"
[ -f "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ] && source "$ZSH_CUSTOM/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"

# --- Env vars ---
export EDITOR="nvim"
export HIST_STAMPS="yyyy-mm-dd"
unsetopt share_history
export LC_ALL=en_US.UTF-8

# Core paths
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:${KREW_ROOT:-$HOME/.krew}/bin:$PATH"

# VCPKG
export VCPKG_ROOT="$HOME/vcpkg"
export PATH="$PATH:$VCPKG_ROOT"

# Gradle
export GRADLE_USER_HOME="$HOME/.gradle"
export GRADLE_HOME="$HOME/.gradle"

# Brew wrapper (mac only, sketchybar hook)
function brew() {
  command brew "$@" 
  if [[ $* =~ "upgrade" ]] || [[ $* =~ "update" ]] || [[ $* =~ "outdated" ]]; then
    {{ if eq .chezmoi.os "darwin" }}sketchybar --trigger brew_update{{ end }}
  fi
}

# --- OS-specific ---
{{ if eq .chezmoi.os "darwin" }}
  export HOMEBREW_NO_AUTO_UPDATE=1
  export PATH="/opt/homebrew/bin:/opt/homebrew/sbin:$PATH"

  # macOS 1Password agent
  export SSH_AUTH_SOCK="$HOME/Library/Group Containers/2BUA8C4S2C.com.1password/t/agent.sock"

  # Android SDK
  export ANDROID_HOME="$HOME/Library/Android/sdk"
  export ANDROID_SDK_ROOT="$ANDROID_HOME"
  export PATH="$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin"
{{ else if eq .chezmoi.os "linux" }}
  # Linux Android SDK (if installed)
  export ANDROID_HOME="$HOME/Android/Sdk"
  export ANDROID_SDK_ROOT="$ANDROID_HOME"
  export PATH="$PATH:/opt/nvim-linux-x86_64/bin"
  export PATH="$PATH:/usr/local/go/bin"
  export PATH="$HOME/go/bin:$PATH"
  [ -d "$ANDROID_HOME" ] && export PATH="$PATH:$ANDROID_HOME/emulator:$ANDROID_HOME/platform-tools:$ANDROID_HOME/cmdline-tools/latest/bin"
  # SSH Agent forwarding fix for tmux (when using ssh -A)
  if [ -n "$SSH_AUTH_SOCK" ] && [ "$SSH_AUTH_SOCK" != "$HOME/.ssh/ssh_auth_sock" ]; then
    mkdir -p ~/.ssh
    ln -sf "$SSH_AUTH_SOCK" ~/.ssh/ssh_auth_sock
  fi
  export SSH_AUTH_SOCK="$HOME/.ssh/ssh_auth_sock"

  # Function to update SSH agent in tmux
  update_ssh_auth_sock() {
    if [ -n "$SSH_AUTH_SOCK" ] && [ -n "$TMUX" ]; then
      # Test if current socket actually has identities
      if ! ssh-add -l >/dev/null 2>&1; then
        # Current socket doesn't work, find a working one
        for sock in /tmp/ssh-*/agent.*; do
          if [ -S "$sock" ] && SSH_AUTH_SOCK="$sock" ssh-add -l >/dev/null 2>&1; then
            ln -sf "$sock" ~/.ssh/ssh_auth_sock
            tmux set-environment SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock >/dev/null 2>&1
            echo "SSH agent updated to: $sock"
            break
          fi
        done
      else
        # Current socket works, just ensure tmux environment is set
        tmux set-environment SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock >/dev/null 2>&1
      fi
    fi
  }

  # Hook into prompt to refresh SSH socket automatically
  precmd() {
    if [ -n "$SSH_AUTH_SOCK" ] && [ -n "$TMUX" ]; then
      # Test if current SSH agent has identities, if not, find a working one
      if ! ssh-add -l >/dev/null 2>&1; then
        for sock in /tmp/ssh-*/agent.*; do
          if [ -S "$sock" ] && SSH_AUTH_SOCK="$sock" ssh-add -l >/dev/null 2>&1; then
            ln -sf "$sock" ~/.ssh/ssh_auth_sock
            tmux set-environment SSH_AUTH_SOCK ~/.ssh/ssh_auth_sock >/dev/null 2>&1
            break
          fi
        done
      fi
    fi
  }

  # Initial update for current session
  update_ssh_auth_sock
  # NVM (Node Version Manager)
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
{{ end }}

# Project-local env (optional)
[ -f "$HOME/.local/bin/env" ] && . "$HOME/.local/bin/env"

# SDKMAN (if installed)
export SDKMAN_DIR="$HOME/.sdkman"
[[ -s "$SDKMAN_DIR/bin/sdkman-init.sh" ]] && source "$SDKMAN_DIR/bin/sdkman-init.sh"
