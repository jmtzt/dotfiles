---
- name: Machine setup
  hosts: localhost
  connection: local
  become: true
  gather_facts: true

  vars:
    remote_regular_user: "{{ ansible_env.SUDO_USER or ansible_user_id }}"
    ansible_shell_executable: /bin/bash

    # NodeSource repo (Node 22)
    nodesource_keyring_dir: /etc/apt/keyrings
    nodesource_key_asc: /etc/apt/keyrings/nodesource.asc
    nodesource_key_gpg: /etc/apt/keyrings/nodesource.gpg
    nodesource_repo_line: "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_22.x nodistro main"

    # Pin git clones (use tags/SHAs to satisfy ansible-lint latest[git])
    ohmyzsh_version: master
    tmux_repo_version: master
    zsh_autosuggest_version: master
    zsh_syntax_highlight_version: master
    zsh_fzf_hist_version: master
    fast_syntax_highlight_version: master
    nvim_config_version: main

  tasks:
    ###########################################################################
    # Base system prep
    ###########################################################################
    - name: Update apt cache (initial)
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - git
          - curl
          - htop
          - vim
          - build-essential
          - ripgrep
          - zsh
          - fzf
          - tmux
          - zlib1g
          - zlib1g-dev
          - patch
          - libssl-dev
          - luarocks
          - fd-find
          - direnv
          - tree
          - software-properties-common
          - openssh-client
          - ca-certificates
          - gnupg
        state: present

    - name: Ensure fd is available as 'fd' on Debian/Ubuntu (symlink fdfind if present)
      ansible.builtin.stat:
        path: /usr/bin/fdfind
      register: fdfind_bin

    - name: Create fd symlink
      ansible.builtin.file:
        src: /usr/bin/fdfind
        dest: /usr/local/bin/fd
        state: link
      when:
        - ansible_facts['os_family'] == 'Debian'
        - fdfind_bin.stat.exists

    ###########################################################################
    # NodeSource repository setup (Node 22)
    ###########################################################################
    - name: Create keyrings directory
      ansible.builtin.file:
        path: "{{ nodesource_keyring_dir }}"
        state: directory
        mode: "0755"

    - name: Download NodeSource GPG key (ASCII)
      ansible.builtin.get_url:
        url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
        dest: "{{ nodesource_key_asc }}"
        mode: "0644"
        force: true

    - name: Convert NodeSource key to keyring
      ansible.builtin.command:
        argv:
          - gpg
          - --dearmor
          - -o
          - "{{ nodesource_key_gpg }}"
          - "{{ nodesource_key_asc }}"
        creates: "{{ nodesource_key_gpg }}"

    - name: Add NodeSource repository (Node 22)
      ansible.builtin.apt_repository:
        repo: "{{ nodesource_repo_line }}"
        filename: "nodesource"
        state: present
      notify: Update apt cache

    ###########################################################################
    # Git PPA (stable Git) and install
    ###########################################################################
    - name: Add Git PPA repository
      ansible.builtin.apt_repository:
        repo: ppa:git-core/ppa
        state: present
      notify: Update apt cache

    - name: Ensure Git is upgraded to the latest version
      ansible.builtin.apt:
        name: git
        state: latest
      register: git_pkg

    - name: Show installed Git version
      ansible.builtin.command:
        argv: ["git", "--version"]
      changed_when: false
      when: git_pkg is changed

    ###########################################################################
    # Configure Git for the regular user
    ###########################################################################
    - name: Configure global Git identity and signing
      become: true
      become_user: "{{ remote_regular_user }}"
      block:
        - name: Ensure ~/.gitconfig exists
          ansible.builtin.file:
            path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.gitconfig"
            state: touch
            owner: "{{ remote_regular_user }}"
            group: "{{ remote_regular_user }}"
            mode: "0644"

        - name: Write Git config (managed block)
          ansible.builtin.blockinfile:
            path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.gitconfig"
            marker: "# {mark} ANSIBLE MANAGED GIT CONFIG"
            create: true
            owner: "{{ remote_regular_user }}"
            group: "{{ remote_regular_user }}"
            mode: "0644"
            block: |
              [user]
                name = Joao Tozato
                email = joao.tozato@voize.de
                signingkey = ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIN52Pm/N1JReKh1ysY1h3xqP4XX6VxVk4H4ropc9vP52
              [gpg]
                format = ssh
              [commit]
                gpgsign = true

    ###########################################################################
    # Install zoxide
    ###########################################################################
    - name: Download zoxide install script
      become: true
      become_user: "{{ remote_regular_user }}"
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh
        dest: /tmp/zoxide_install.sh
        mode: "0755"

    - name: Run zoxide install script (no profiles/rc)
      become: true
      become_user: "{{ remote_regular_user }}"
      ansible.builtin.command:
        argv:
          - /bin/bash
          - --noprofile
          - --norc
          - /tmp/zoxide_install.sh
      args:
        creates: "/home/{{ remote_regular_user }}/.local/bin/zoxide"
      environment:
        LC_ALL: C.UTF-8
        LANG: C.UTF-8

    - name: Configure zoxide init in ~/.zshrc
      become: true
      become_user: "{{ remote_regular_user }}"
      ansible.builtin.lineinfile:
        path: "/home/{{ remote_regular_user }}/.zshrc"
        create: true
        owner: "{{ remote_regular_user }}"
        group: "{{ remote_regular_user }}"
        mode: "0644"
        line: 'eval "$(zoxide init zsh)"'
        insertafter: EOF
        state: present

    ###########################################################################
    # User-scope: Neovim under ~/.local
    ###########################################################################
    - name: Install Neovim under ~/.local (user scope)
      become_user: "{{ remote_regular_user }}"
      block:
        - name: Ensure ~/.local/{bin,opt} exist
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - "~/.local/bin"
            - "~/.local/opt"

        - name: Download Neovim binary tarball from GitHub release
          ansible.builtin.get_url:
            url: "https://github.com/jmtzt/dotfiles/releases/download/nvim-0.12.0-dev-glibc231/nvim-linux-x86_64-glibc231.tar.gz"
            dest: "~/.local/opt/nvim.tar.gz"
            mode: "0644"
            force: true
          register: nvim_tar

        - name: Remove previous extracted nvim (if new tarball downloaded)
          ansible.builtin.file:
            path: "~/.local/opt/nvim"
            state: absent
          when: nvim_tar.changed

        - name: Create ~/.local/opt/nvim (extract target)
          ansible.builtin.file:
            path: "~/.local/opt/nvim"
            state: directory
            mode: "0755"

        - name: Extract Neovim tarball (no assumptions about layout)
          ansible.builtin.unarchive:
            src: "~/.local/opt/nvim.tar.gz"
            dest: "~/.local/opt/nvim"
            remote_src: true
            extra_opts: [--no-same-owner]

        - name: Find nvim binary under ~/.local/opt/nvim
          ansible.builtin.find:
            paths: "~/.local/opt/nvim"
            recurse: true
            patterns: "nvim"
            file_type: file
          register: nvim_find

        - name: Fail if nvim binary not found
          ansible.builtin.fail:
            msg: "Neovim binary not found after extraction."
          when: (nvim_find.files | selectattr('path','search','/bin/nvim$') | list | length) == 0

        - name: Symlink nvim into ~/.local/bin (from detected path)
          ansible.builtin.file:
            src: "{{ (nvim_find.files | selectattr('path','search','/bin/nvim$') | map(attribute='path') | first) }}"
            dest: "~/.local/bin/nvim"
            state: link
            force: true

    ###########################################################################
    # User-scope: Fonts, Tmux, Zsh, Neovim config
    ###########################################################################
    - name: Setup fonts and dotfiles
      become: true
      become_user: "{{ remote_regular_user }}"
      block:
        - name: Ensure fonts dir
          ansible.builtin.file:
            path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.fonts"
            state: directory
            mode: "0755"

        - name: Check if JetBrains Mono Nerd Font exists
          ansible.builtin.stat:
            path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.fonts/JetBrainsMonoNerdFontMono-Regular.ttf"
          register: jetbrains_font

        - name: Download JetBrains Mono Nerd Font (if missing)
          ansible.builtin.unarchive:
            src: "https://github.com/ryanoasis/nerd-fonts/releases/download/v3.1.1/JetBrainsMono.zip"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.fonts/"
            remote_src: true
          when: not jetbrains_font.stat.exists

        - name: Clone Oh My Tmux
          ansible.builtin.git:
            repo: "https://github.com/gpakosz/.tmux.git"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.tmux"
            version: "{{ tmux_repo_version }}"
            depth: 1
            update: true

        - name: Symlink .tmux.conf
          ansible.builtin.file:
            src: "{{ lookup('ansible.builtin.env', 'HOME') }}/.tmux/.tmux.conf"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.tmux.conf"
            state: link
            force: true

        - name: Copy local tmux config if present
          ansible.builtin.stat:
            path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.local/share/chezmoi/dot_tmux.conf.local"
          register: tmux_local

        - name: Copy tmux.conf.local
          ansible.builtin.copy:
            src: "{{ lookup('ansible.builtin.env', 'HOME') }}/.local/share/chezmoi/dot_tmux.conf.local"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.tmux.conf.local"
            remote_src: true
            mode: "0644"
          when: tmux_local.stat.exists

        - name: Ensure custom zsh plugin dirs
          ansible.builtin.file:
            path: "{{ item }}"
            state: directory
            mode: "0755"
          loop:
            - "{{ lookup('ansible.builtin.env', 'HOME') }}/.config/zsh/custom/plugins"
            - "{{ lookup('ansible.builtin.env', 'HOME') }}/.config/zsh/custom/themes"

        - name: Install Oh My Zsh and plugins
          loop:
            - { repo: "https://github.com/ohmyzsh/ohmyzsh.git", dest: "~/.oh-my-zsh" }
            - { repo: "https://github.com/zsh-users/zsh-autosuggestions.git", dest: "~/.config/zsh/custom/plugins/zsh-autosuggestions" }
            - { repo: "https://github.com/zsh-users/zsh-syntax-highlighting.git", dest: "~/.config/zsh/custom/plugins/zsh-syntax-highlighting" }
            - { repo: "https://github.com/joshskidmore/zsh-fzf-history-search.git", dest: "~/.config/zsh/custom/plugins/zsh-fzf-history-search" }
            - { repo: "https://github.com/zdharma-continuum/fast-syntax-highlighting.git", dest: "~/.config/zsh/custom/plugins/fast-syntax-highlighting" }
          ansible.builtin.git:
            repo: "{{ item.repo }}"
            dest: "{{ item.dest | expanduser }}"
            depth: 1
            update: true

        - name: Clone Neovim config
          ansible.builtin.git:
            repo: "https://github.com/jmtzt/vim.git"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.config/nvim"
            version: "{{ nvim_config_version }}"
            depth: 1
            update: true

        - name: Clone Neovim-mini config
          ansible.builtin.git:
            repo: "https://github.com/jmtzt/nvim.git"
            dest: "{{ lookup('ansible.builtin.env', 'HOME') }}/.config/nvim-mini"
            version: "{{ nvim_config_version }}"
            depth: 1
            update: true

  ###############################################################################
  # User-scope: Rust (rustup) + tree-sitter-cli (built locally)
  ###############################################################################
    - name: Install rustup and tree-sitter-cli for regular user
      become: true
      become_user: "{{ remote_regular_user }}"
      block:
        - name: Ensure ~/.cargo/bin exists
          ansible.builtin.file:
            path: "/home/{{ remote_regular_user }}/.cargo/bin"
            state: directory
            mode: "0755"

        - name: Install rustup (coexist with system Rust; skip PATH check)
          ansible.builtin.shell: |
            set -euo pipefail
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs \
            | RUSTUP_INIT_SKIP_PATH_CHECK=yes sh -s -- -y
          args:
            executable: /bin/bash
            creates: "/home/{{ remote_regular_user }}/.cargo/bin/rustup"
          environment:
            # Quiet the locale warning you saw earlier
            LC_ALL: C.UTF-8
            LANG: C.UTF-8

        - name: Add cargo bin to PATH in .zshrc
          ansible.builtin.lineinfile:
            path: "/home/{{ remote_regular_user }}/.zshrc"
            create: true
            owner: "{{ remote_regular_user }}"
            group: "{{ remote_regular_user }}"
            mode: "0644"
            line: 'export PATH="$HOME/.cargo/bin:$PATH"'
            insertafter: EOF
            state: present

        - name: Add cargo bin to PATH in .bashrc (for non-zsh shells)
          ansible.builtin.lineinfile:
            path: "/home/{{ remote_regular_user }}/.bashrc"
            create: true
            owner: "{{ remote_regular_user }}"
            group: "{{ remote_regular_user }}"
            mode: "0644"
            line: 'export PATH="$HOME/.cargo/bin:$PATH"'
            insertafter: EOF
            state: present

        - name: Update rustup to latest stable and make it default
          ansible.builtin.shell: |
            set -euo pipefail
            source "$HOME/.cargo/env"
            rustup update stable
            rustup default stable
          args:
            executable: /bin/bash
          changed_when: false  # rustup is idempotent enough; avoid noisy diffs

        - name: Install tree-sitter-cli (latest, built locally)
          ansible.builtin.shell: |
            set -euo pipefail
            source "$HOME/.cargo/env"
            cargo install tree-sitter-cli --locked
          args:
            executable: /bin/bash
            creates: "/home/{{ remote_regular_user }}/.cargo/bin/tree-sitter"

        - name: Verify tree-sitter version
          ansible.builtin.shell: |
            set -euo pipefail
            source "$HOME/.cargo/env"
            tree-sitter --version
          args:
            executable: /bin/bash
          register: treesitter_version
          changed_when: false

        - name: Show tree-sitter version
          ansible.builtin.debug:
            msg: "{{ treesitter_version.stdout }}"


    ###########################################################################
    # Switch shell to zsh
    ###########################################################################
    - name: Change default shell to zsh for user
      ansible.builtin.user:
        name: "{{ remote_regular_user }}"
        shell: /usr/bin/zsh

  handlers:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

    - name: Remove NodeSource ASCII key
      ansible.builtin.file:
        path: "{{ nodesource_key_asc }}"
        state: absent

    - name: Remove previous extracted nvim
      ansible.builtin.file:
        path: "{{ lookup('ansible.builtin.env', 'HOME') }}/.local/opt/nvim"
        state: absent
